<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ইসলামিক দোয়া স্টিকার কার্ড</title>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-MXKPWCPH');</script>
<script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
    /* STYLES FOR FULLSCREEN IMAGE MODAL */
/* STYLES FOR FULLSCREEN IMAGE MODAL */
.modal {
    display: none; /* This is crucial to hide it by default */
    position: fixed;
    z-index: 2000;
    padding: 0;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.9);
    /* Add the flex properties here for centering */
    align-items: center;
    justify-content: center;
}

/* This new class will be added by JavaScript to show the modal */
.modal.is-visible {
    display: flex;
}

.modal-content {
    margin: auto;
    display: block;
    width: 100%; /* Changed */
    max-width: 90vw; /* Changed for responsive width */
    max-height: 90vh; /* Added for responsive height */
    object-fit: contain; /* Ensures the whole image is visible */
    transition: transform 0.2s ease-in-out;
}

/* Media query for smaller screens */
@media screen and (max-width: 700px) {
    .modal-content {
        width: 100vw; /* Use full viewport width */
        height: 100vh; /* Use full viewport height */
        max-width: 100vw;
        max-height: 100vh;
        border-radius: 0; /* Remove rounded corners on small screens */
    }

    .close-modal {
        top: 15px;
        right: 25px;
        font-size: 35px;
        cursor: pointer;
    z-index: 2003; /* Ensures it's on top of everything */
    padding: 8px; /* Increases the tappable area */
    line-height: 0.5; /* Helps vertically center the '×' */
    }
    
    .modal-prev, .modal-next {
      font-size: 18px;
      padding: 12px;
    }
}

.modal-content.zoomed {
    transform: scale(1.5);
    cursor: move;
}


#caption {
    margin: auto;
    display: block;
    width: 80%;
    max-width: 700px;
    text-align: center;
    color: #ccc;
    padding: 10px 0;
    /* Hide caption on small screens to maximize image space */
    position: absolute;
    bottom: 15px;
    left: 50%;
    transform: translateX(-50%);
}

@media screen and (max-width: 700px) {
    #caption {
      display: none;
    }
}

.close-modal {
    position: absolute;
    top: 15px;
    right: 35px;
    color: #f1f1f1;
    font-size: 40px;
    font-weight: bold;
    transition: 0.3s;
    cursor: pointer;
}

.close-modal:hover,
.close-modal:focus {
    color: #bbb;
    text-decoration: none;
    cursor: pointer;
}

.modal-prev, .modal-next {
    cursor: pointer;
    position: absolute;
    top: 50%;
    width: auto;
    padding: 16px;
    margin-top: -50px;
    color: white;
    font-weight: bold;
    font-size: 20px;
    transition: 0.6s ease;
    border-radius: 0 3px 3px 0;
    user-select: none;
    -webkit-user-select: none;
    background-color: rgba(0,0,0,0.8);
    z-index: 2002; /* Add this line */
}

.modal-next {
    right: 0;
    border-radius: 3px 0 0 3px;
}

.modal-prev {
    left: 0;
    
}

.modal-prev:hover, .modal-next:hover {
    background-color: rgba(0,0,0,1);
}

/* Zoom controls */
.zoom-controls {
    position: absolute;
    top: 15px;
    left: 15px;
    z-index: 2001;
}

.zoom-btn {
    background-color: rgba(0,0,0,0.5);
    color: white;
    border: none;
    padding: 10px;
    font-size: 20px;
    cursor: pointer;
    border-radius: 3px;
    margin-right: 5px;
}

.zoom-btn:hover {
    background-color: rgba(0,0,0,0.8);
}
/* STYLES FOR FULLSCREEN IMAGE MODAL */
  
        body {
            font-family: 'Hind Siliguri', sans-serif;
        }
        .slider-container {
            position: relative;
            max-width: 100%;
            margin: auto;
            overflow: hidden;
            border-radius: 0.5rem;
        }
        .slider-image, .slider-video {
            display: none;
            width: 100%;
            height: auto;
            animation: fade 1.5s;
        }
        @keyframes fade {
            from {opacity: .4}
            to {opacity: 1}
        }
        .prev, .next {
            cursor: pointer;
            position: absolute;
            top: 50%;
            width: auto;
            padding: 16px;
            margin-top: -22px;
            color: white;
            font-weight: bold;
            font-size: 18px;
            transition: 0.6s ease;
            border-radius: 0 3px 3px 0;
            user-select: none;
            background-color: rgba(0,0,0,0.5);
            z-index: 10;
        }
        .next {
            right: 0;
            border-radius: 3px 0 0 3px;
        }
        .prev:hover, .next:hover {
            background-color: rgba(0,0,0,0.8);
        }
        .dots-container {
            text-align: center;
            padding: 10px;
        }
        .dot {
            cursor: pointer;
            height: 15px;
            width: 15px;
            margin: 0 2px;
            background-color: #bbb;
            border-radius: 50%;
            display: inline-block;
            transition: background-color 0.6s ease;
        }
        .active, .dot:hover {
            background-color: #717171;
        }
        .radio-label {
            border: 2px solid #e2e8f0;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        input[type="radio"]:checked + .radio-label {
            border-color: #2c7a7b;
            background-color: #e6fffa;
            color: #234e52;
            font-weight: 600;
        }
        .aspect-9-16 {
            position: relative;
            width: 100%;
            padding-top: 177.77%;
            background-color: #000;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .aspect-9-16 video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        /* UPDATED & NEW STYLES FOR CHAT BUTTONS */
        .fab-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 16px;
}
.fab-item {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 12px;
}
.fab-text {
    background-color: white;
    padding: 6px 12px;
    border-radius: 16px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    font-size: 14px;
    font-weight: 600;
    color: #374151;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
    white-space: nowrap;
}
.fab-item:hover .fab-text {
    opacity: 1;
    visibility: visible;
}
.chat-fab {
    color: white;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    transition: transform 0.3s;
}
.chat-fab:hover {
    transform: scale(1.1);
}
.whatsapp-fab {
    background-color: #25D366;
}
.messenger-fab {
    background-color: #00B2FF;
}
        /* Spinning Wheel Styles */
        #spin-container {
            padding: 2rem;
            margin-top: 1.5rem;
            text-align: center;
            background-color: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
        }
        .wheel-wrapper {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 1.5rem auto;
        }
        .wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            border: 8px solid #dbeafe;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            transition: transform 5s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        .segment {
            position: absolute;
            width: 50%;
            height: 50%;
            top: 0;
            left: 50%;
            transform-origin: 0% 100%;
            clip-path: polygon(0 0, 100% 0, 100% 1.5%, 0 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #4a5568;
            padding-right: 40px; /* Push text towards center */
            box-sizing: border-box;
        }
        .segment span {
             display: block;
            transform: rotate(-50deg);
            text-align: center;
            font-size: 13px;
            max-width: 80px;
            line-height: 1.2;
            font-weight: 900;
        }
        .pointer {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 30px solid #ef4444;
            z-index: 10;
        }
        #spin-btn {
            margin-top: 1rem;
            padding: 0.75rem 1.5rem;
            font-size: 1.1rem;
            font-weight: 700;
            color: white;
            background-color: #16a34a;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #spin-btn:hover {
            background-color: #15803d;
        }
        #spin-btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        #spin-result {
            margin-top: 1.5rem;
            font-size: 1.25rem;
            font-weight: 700;
            color: #16a34a;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MXKPWCPH"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<div class="container mx-auto p-4 md:p-8 max-w-4xl">
        
        <header class="text-center mb-8">
            <h1 id="productTitle" class="text-3xl md:text-4xl font-bold text-green-800">আপনার ঘরে নিয়ে আসুন রহমত ও বরকত!</h1>
            <p class="text-lg md:text-xl mt-2 text-gray-600">ইসলামিক দোয়া স্টিকার কার্ডের সাথে প্রতিদিন আল্লাহকে স্মরণ করুন।</p>
        </header>

        <main class="grid grid-cols-1 md:grid-cols-2 gap-8">

            <div class="space-y-6">
                <div id="imageSlider" class="slider-container shadow-lg"></div>
                <div id="imageDots" class="dots-container"></div>
                <div id="videoSlider" class="slider-container shadow-lg aspect-9-16"></div>
                <div id="videoDots" class="dots-container"></div>
                
                <div id="spin-container">
                    <h3 class="text-2xl font-bold text-gray-800">একটি ফ্রি স্পিন জিতে নিন!</h3>
                    <p class="text-gray-600 mb-2">সম্পূর্ণ ক্যাশ অন ডেলিভারী। নিচের ফর্ম এ শুধু নাম ঠিকানা ও ফোন নাম্বার এড করে অর্ডার করুন এবং জিতে নিন আকর্ষণীয় পুরস্কার!</p>
                    <div class="wheel-wrapper">
                        <div class="pointer"></div>
                        <div id="wheel" class="wheel"></div>
                    </div>
                    <p id="spin-activation-msg" class="text-red-600 font-semibold my-2">অর্ডার করার পর স্পিন বাটনটি চালু হবে।</p>
                    <button id="spin-btn" disabled>Spin for a Reward!</button>
                    <div id="spin-result"></div>
                    <div class="mt-4 text-sm text-gray-500">
                        <p>প্রতিটি অর্ডারের সাথে থাকছে একটি নিশ্চিত পুরস্কার জেতার সুযোগ।</p>
                        <p>আপনার জেতা পুরস্কারটি আপনার অর্ডারের সাথে আপনাকে পাঠানো হবে</p>
                    </div>
                </div>

                <div id="customer-feedback-section" class="mt-8 space-y-6 hidden">
                    <h2 id="feedback-title" class="text-3xl font-bold text-center text-green-800"></h2>
                    <div id="feedback-slider-container" class="slider-container shadow-lg"></div>
                    <div id="feedback-dots-container" class="dots-container"></div>
                    <p id="feedback-description" class="text-gray-600 text-center px-4"></p>
                </div>

            </div>

            <div id="order-section" class="bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold mb-4 text-green-700">কেন আমাদের দোয়া স্টিকার কিনবেন?</h2>
                
                <div id="productDescription" class="text-gray-700 space-y-3">
                    <p id="main-description" class="mb-4">আমাদের এই আকর্ষণীয় ডিজাইনের স্টিকার কার্ডগুলো শুধু আপনার ঘরের সৌন্দর্যই বাড়াবে না, বরং প্রতিদিনের ছোট ছোট আমলগুলো মনে করিয়ে দিয়ে আপনার ঈমানকে আরও মজবুত করবে। প্রতিটি প্যাকেজেই দৈনন্দিন জীবনের জন্য প্রয়োজনীয় দোয়াগুলো অন্তর্ভুক্ত করা হয়েছে।</p>
                    
                    <div id="package-24-details">
                        <h4 id="package-24-title" class="font-semibold text-lg mt-4 mb-2 text-green-700"></h4>
                        <ul id="package-24-ul" class="list-disc list-inside space-y-1 text-gray-600">
                            </ul>
                    </div>

                    <div id="package-48-details" class="hidden">
                        <h4 id="package-48-title" class="font-semibold text-lg mt-6 mb-2 text-green-700"></h4>
                         <p id="package-48-subtitle" class="mb-2 text-gray-600 hidden">এই প্যাকেজে ২৪ পিসের সবগুলো দোয়ার সাথে অতিরিক্ত আরও প্রয়োজনীয় দোয়া রয়েছে:</p>
                        <ul id="package-48-ul" class="list-disc list-inside space-y-1 text-gray-600">
                             </ul>
                    </div>
                </div>
                <div id="productOptions" class="my-6 space-y-4">
                    <div>
                        <h3 class="font-semibold mb-2">সাইজ সিলেক্ট করুন:</h3>
                        <div class="flex gap-4">
                            <input type="radio" name="size" id="size_medium" value="medium" class="hidden" checked>
                            <label for="size_medium" class="radio-label text-center w-full">মিডিয়াম</label>
                            <input type="radio" name="size" id="size_big" value="big" class="hidden">
                            <label for="size_big" class="radio-label text-center w-full">বড়</label>
                        </div>
                    </div>
                     <div>
                        <h3 class="font-semibold mb-2">পরিমাণ সিলেক্ট করুন:</h3>
                        <div class="flex gap-4">
                            <input type="radio" name="quantity" id="quantity_24" value="24" class="hidden" checked>
                            <label for="quantity_24" class="radio-label text-center w-full">২৪ পিস</label>
                            <input type="radio" name="quantity" id="quantity_48" value="48" class="hidden">
                            <label for="quantity_48" class="radio-label text-center w-full">৪৮ পিস</label>
                        </div>
                    </div>
                </div>

                <div class="my-6 text-center bg-gray-100 p-4 rounded-lg space-y-2">
                    <p class="text-lg text-gray-800">দাম: <span id="dynamicPrice" class="font-semibold">200</span> টাকা</p>
                    <p class="text-lg text-gray-800">ডেলিভারি চার্জ: <span id="deliveryFee" class="font-semibold">70</span> টাকা</p>
                    <hr class="border-gray-300">
                    <p class="text-2xl font-bold text-red-600">সর্বমোট: <span id="totalPrice">270</span> টাকা</p>
                </div>

                <form id="orderForm" class="space-y-4">
                    <input type="hidden" id="selectedProduct" name="selectedProduct" value="মিডিয়াম - ২৪ পিস">
                    <input type="hidden" id="productPriceInput" name="productPriceInput" value="200">
                    <input type="hidden" id="totalPriceInput" name="totalPriceInput" value="270">
                    <h3 class="text-xl font-semibold text-center bg-gray-100 p-2 rounded">অর্ডার করতে নিচের ফর্মটি পূরণ করুন</h3>
                    <div>
                        <label for="name" class="block mb-1 font-medium">আপনার নাম <span class="text-red-500">*</span></label>
                        <input type="text" id="name" name="name" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500" required>
                    </div>
                    <div>
                        <label for="address" class="block mb-1 font-medium">আপনার সম্পূর্ণ ঠিকানা <span class="text-red-500">*</span></label>
                        <textarea id="address" name="address" rows="3" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500" placeholder="বাসা/হোল্ডিং, রোড, এলাকা, থানা, জেলা" required></textarea>
                    </div>
                    <div>
                        <label for="phone" class="block mb-1 font-medium">আপনার ফোন নম্বর <span class="text-red-500">*</span></label>
                        <input type="tel" id="phone" name="phone" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500" required>
                    </div>
                     <div id="optional-field-container">
                        <label for="optional-note" class="block mb-1 font-medium">বিশেষ দ্রষ্টব্য (Optional)</label>
                        <textarea id="optional-note" name="note" rows="2" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500"></textarea>
                    </div>
                    <button type="submit" class="w-full bg-green-700 text-white font-bold py-3 px-4 rounded-md hover:bg-green-800 transition duration-300">
                        অর্ডার কনফার্ম করুন
                    </button>
                </form>

                 <div id="successMessage" class="hidden mt-4 p-4 bg-green-100 text-green-800 border border-green-300 rounded-md text-center">
                    <p>অভিনন্দন! আপনার অর্ডারটি আমরা পেয়েছি। খুব শীঘ্রই আমাদের প্রতিনিধি আপনাকে কল করবে।</p>
                    <p class="mt-4 font-semibold text-lg">আপনার অর্ডার নাম্বার - <strong id="orderIdDisplay" class="text-red-600"></strong> 
                        <button id="copyOrderIdBtn" class="ml-2 px-3 py-1 text-sm bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none">কপি</button>
                    </p>
                    <p class="mt-4">আপনার এই অর্ডারের জন্য থাকছে একটি নিশ্চিত উপহার! উপরের স্পিন বাটনে ক্লিক করে চাকাটি ঘুরিয়ে জিতে নিন আপনার আকর্ষণীয় পুরস্কারটি।</p>
                    <button id="scrollToSpinBtn" class="w-full bg-yellow-500 text-white font-bold py-3 px-4 rounded-md hover:bg-yellow-600 transition duration-300 mt-4">
                        স্পিন করুন
                    </button>
                </div>
            </div>
        </main>
        
        <section id="order-tracking-section" class="mt-12 p-6 bg-white rounded-lg shadow-lg max-w-4xl mx-auto">
            <h3 class="text-xl font-semibold text-center mb-4 text-gray-800">আপনার অর্ডার ট্র্যাক করুন</h3>
            <p class="text-center text-gray-600 mb-6">আপনার অর্ডার সম্পর্কিত তথ্য দেখতে বা আপনার ঠিকানা পরিবর্তন করতে অর্ডার নাম্বার বা ফোন নাম্বার দিয়ে অনুসন্ধান করুন।</p>
            <form id="trackOrderForm" class="flex flex-col md:flex-row gap-4 items-stretch justify-center">
                <input type="text" id="trackingInput" name="trackingInput" class="w-full md:w-1/2 p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" placeholder="আপনার অর্ডার নাম্বার বা ফোন নাম্বার দিন" required>
                <button type="submit" class="w-full md:w-auto bg-blue-600 text-white font-bold py-3 px-6 rounded-md hover:bg-blue-700 transition duration-300">
                    ট্র্যাক করুন
                </button>
            </form>
            <div id="trackingResult" class="mt-6 hidden">
                </div>
            <p id="trackingError" class="text-red-500 text-center mt-4 hidden"></p>
        </section>


        <footer class="text-center mt-10 pt-6 border-t">
            <h3 class="text-xl font-bold mb-2">ডেলিভারি সংক্রান্ত তথ্য</h3>
            <p class="text-gray-600">সারা দেশে ফ্ল্যাট <strong>৭০ টাকা</strong> হোম ডেলিভারি।</p>
            <p class="text-gray-600 mt-2">যেকোনো প্রয়োজনে কল করুন: <strong class="text-green-700">01884031111</strong></p>
        </footer>
    </div>
    
   <div class="fab-container">
    <div class="fab-item">
        <span class="fab-text">Messenger-এ চ্যাট করুন</span>
        <a id="messenger-chat-link" href="#" target="_blank" class="chat-fab messenger-fab" style="display: none;" title="Chat with us on Messenger">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" fill="currentColor" width="28" height="28">
                <path d="M16 2.898c-7.55 0-13.623 5.432-13.623 12.155 0 4.23 2.213 7.95 5.625 10.142v4.846l4.9-2.32c1.073.228 2.196.35 3.352.35 7.55 0 13.623-5.432 13.623-12.155S23.55 2.898 16 2.898zm1.144 18.283l-3.282-3.486-6.438 3.486L13.862 15 17.14 18.48l6.438-3.48-6.438 6.183z"></path>
            </svg>
        </a>
    </div>
    <div class="fab-item">
        <span class="fab-text">WhatsApp-এ চ্যাট করুন</span>
        <a id="whatsapp-chat-link" href="#" target="_blank" class="chat-fab whatsapp-fab" style="display: none;" title="Chat with us on WhatsApp">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill="currentColor" width="28" height="28">
                <path d="M380.9 97.1C339 55.1 283.2 32 223.9 32c-122.4 0-222 99.6-222 222 0 39.1 10.2 77.3 29.6 111L0 480l117.7-30.9c32.4 17.7 68.9 27 106.1 27h.1c122.3 0 224.1-99.6 224.1-222 0-59.3-25.2-115-67.1-157zm-157 341.6c-33.8 0-67.6-9.5-97.2-27.2l-6.7-4-71.6 18.7 19.3-68.6-4.4-7c-18.5-29.4-28.2-63.3-28.2-98.2 0-101.7 82.8-184.5 184.6-184.5 49.3 0 95.6 19.2 130.4 54.1 34.8 34.9 56.2 81.2 56.1 130.5c.1 101.8-84.9 184.6-186.6 184.6zm101.2-138.2c-5.5-2.8-32.8-16.2-37.9-18-5.1-1.9-8.8-2.8-12.5 2.8-3.7 5.6-14.3 18-17.6 21.8-3.2 3.7-6.5 4.2-12 1.4-32.6-16.3-54-29.1-75.5-66-5.7-9.8 5.7-9.1 16.3-30.4 1.8-3.7.9-6.9-.5-9.7-1.4-2.8-12.5-30.1-17.1-41.2-4.5-10.8-9.1-9.3-12.5-9.5-3.2-.2-6.9-.2-10.6-.2-3.7 0-9.7 1.4-14.8 6.9-5.1 5.6-19.4 19-19.4 46.3 0 27.3 19.9 53.7 22.6 57.4 2.8 3.7 39.1 59.7 94.8 83.8 35.2 15.2 49 16.5 66.6 13.9 10.7-1.6 32.8-13.4 37.4-26.4 4.6-13 4.6-24.1 3.2-26.4-1.3-2.5-5-3.9-10.5-6.6z"/>
            </svg>
        </a>
    </div>
</div>

<!-- fullscreen image view -->
<div id="imageModal" class="modal">
  <span class="close-modal">&times;</span>
  <div class="zoom-controls">
      <button id="zoomInBtn" class="zoom-btn">+</button>
      <button id="zoomOutBtn" class="zoom-btn">-</button>
  </div>
  <a class="modal-prev">&#10094;</a>
  <img class="modal-content" id="modalImage">
  <a class="modal-next">&#10095;</a>
  <div id="caption"></div>
</div>


   <script type="module">


// --- NEW: FULLSCREEN IMAGE MODAL LOGIC ---
        const modal = document.getElementById("imageModal");
        const modalImg = document.getElementById("modalImage");
        let currentModalIndex = 0;
        let currentModalUrls = [];
        let zoomLevel = 1.0;

        function openModal(urls, index) {
            modal.classList.add('is-visible');
            currentModalUrls = urls.map(getGoogleDriveUrl); // Use the same URL transformation
            currentModalIndex = index;
            updateModalImage();
            resetZoom();
        }

        function updateModalImage() {
            if (currentModalIndex >= 0 && currentModalIndex < currentModalUrls.length) {
                modalImg.src = currentModalUrls[currentModalIndex];
            }
        }

        function changeModalSlide(n) {
            currentModalIndex += n;
            if (currentModalIndex >= currentModalUrls.length) {
                currentModalIndex = 0;
            } else if (currentModalIndex < 0) {
                currentModalIndex = currentModalUrls.length - 1;
            }
            updateModalImage();
            resetZoom();
        }

        function resetZoom() {
            zoomLevel = 1.0;
            modalImg.style.transform = 'scale(1.0)';
            modalImg.style.top = '0px';
            modalImg.style.left = '0px';
            modalImg.classList.remove('zoomed');
        }
        
        document.querySelector(".close-modal").onclick = () => {
            modal.classList.remove('is-visible');
        }
        document.querySelector(".modal-prev").onclick = () => changeModalSlide(-1);
        document.querySelector(".modal-next").onclick = () => changeModalSlide(1);

        document.getElementById('zoomInBtn').addEventListener('click', () => {
             if (zoomLevel < 3.0) { // Max zoom 3x
                zoomLevel += 0.2;
                modalImg.style.transform = `scale(${zoomLevel})`;
                if (zoomLevel > 1.0) modalImg.classList.add('zoomed');
            }
        });
        document.getElementById('zoomOutBtn').addEventListener('click', () => {
            if (zoomLevel > 1.0) { // Min zoom 1x
                zoomLevel -= 0.2;
                modalImg.style.transform = `scale(${zoomLevel})`;
            }
            if (zoomLevel <= 1.0) {
                 resetZoom();
            }
        });

        // Drag functionality for zoomed image
        let isDragging = false;
        let startX, startY, startTop, startLeft;

        modalImg.addEventListener('mousedown', (e) => {
            if (zoomLevel > 1.0) {
                isDragging = true;
                startX = e.pageX;
                startY = e.pageY;
                startTop = parseInt(modalImg.style.top) || 0;
                startLeft = parseInt(modalImg.style.left) || 0;
                modalImg.style.cursor = 'grabbing';
            }
        });

        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                const newLeft = startLeft + (e.pageX - startX);
                const newTop = startTop + (e.pageY - startY);
                modalImg.style.left = `${newLeft}px`;
                modalImg.style.top = `${newTop}px`;
            }
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
            if (zoomLevel > 1.0) {
                 modalImg.style.cursor = 'move';
            } else {
                 modalImg.style.cursor = 'default';
            }
        });
        // --- END OF MODAL LOGIC ---

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null; // Return null if the cookie is not found
        }

        const firebaseConfig = {
            apiKey: "AIzaSyDw1o2kY5kl5oGNhgDP5rRxfvtK20vz0f0",
            authDomain: "nawarika-73f50.firebaseapp.com",
            projectId: "nawarika-73f50",
            storageBucket: "nawarika-73f50.appspot.com",
            messagingSenderId: "357981390108",
            appId: "1:357981390108:web:ad931ea157c1021314a6d9",
            measurementId: "G-9JRWT461NQ"
        };
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, doc, getDoc, updateDoc, where, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let lastOrderId = null; 
        let rewards = [];
        let lastOrderedSize = null;
        let lastOrderedQuantity = null;

        function getGoogleDriveUrl(originalUrl) {
            if (!originalUrl || typeof originalUrl !== 'string') return '';
            const match = originalUrl.match(/drive\.google\.com.*\/d\/([a-zA-Z0-9_-]+)/);
            if (match && match[1]) {
                const fileId = match[1];
                return `https://lh3.googleusercontent.com/d/${fileId}`;
            }
            return originalUrl;
        }

        function getDirectMediaUrl(originalUrl) {
            if (!originalUrl || typeof originalUrl !== 'string') return '';
            if (originalUrl.includes('dropbox.com')) {
                try {
                    const url = new URL(originalUrl);
                    url.searchParams.set('dl', '1');
                    return url.toString();
                } catch (error) { return originalUrl; }
            }
            if (originalUrl.includes('drive.google.com')) {
                const match = originalUrl.match(/drive\.google\.com.*\/d\/([a-zA-Z0-9_-]+)/);
                if (match && match[1]) {
                    const fileId = match[1];
                    return `https://drive.google.com/uc?export=view&id=${fileId}`;
                }
            }
            return originalUrl;
        }
        
        let imageSlideIndex = 1;
        let videoSlideIndex = 1;
        let feedbackSlideIndex = 1;

    function setupSlider(sliderId, slideClassName, dotsId, slideIndexVarName) {
            const slider = document.getElementById(sliderId);
            const dotsContainer = document.getElementById(dotsId);
            if (!slider || !dotsContainer) return () => {};
            slider.innerHTML = '';
            dotsContainer.innerHTML = '';
            const slideElements = [];
            let imageUrls = []; // Store urls for the modal
            
            return (urls) => {
                imageUrls = urls; // Assign urls to the outer scope variable
                if (!urls || urls.length === 0) {
                    slider.style.display = 'none';
                    dotsContainer.style.display = 'none';
                    return;
                }
                slider.style.display = 'block';
                dotsContainer.style.display = 'block';
                urls.forEach((url, index) => {
                    const directUrl = getGoogleDriveUrl(url);
                    const videoUrl = getDirectMediaUrl(url);
                    const slide = document.createElement('div');
                    slide.className = slideClassName;
                    if (slideClassName.includes('image')) {
                        const img = document.createElement('img');
                        img.src = directUrl;
                        img.alt = `Product Image ${index + 1}`;
                        img.onerror = function() { this.onerror=null; this.src='https://placehold.co/600x400/cccccc/ffffff?text=Image+Not+Found'; };
                        // Add click event to open modal
                        img.onclick = () => openModal(imageUrls, index);
                        slide.appendChild(img);

                    } else {
                        slide.innerHTML = `<video controls playsinline webkit-playsinline loop muted autoplay class="w-full h-full"><source src="${videoUrl}" type="video/mp4"></video>`;
                    }
                    slider.appendChild(slide);
                    slideElements.push(slide);
                    const dot = document.createElement('span');
                    dot.className = 'dot';
                    dot.onclick = () => window[`current${slideIndexVarName}Slide`](index + 1);
                    dotsContainer.appendChild(dot);
                });
                const prevArrow = document.createElement('a');
                prevArrow.className = 'prev';
                prevArrow.onclick = () => window[`plus${slideIndexVarName}Slides`](-1);
                prevArrow.innerHTML = '❮';
                slider.appendChild(prevArrow);
                const nextArrow = document.createElement('a');
                nextArrow.className = 'next';
                nextArrow.onclick = () => window[`plus${slideIndexVarName}Slides`](1);
                nextArrow.innerHTML = '❯';
                slider.appendChild(nextArrow);
                const showSlidesFn = createShowSlidesFn(slideElements, dotsContainer, slideIndexVarName);
                window[`show${slideIndexVarName}Slides`] = showSlidesFn;
                showSlidesFn(1);
            };
        }

        function createShowSlidesFn(slides, dotsContainer, slideIndexVarName) {
            return function(n) {
                let slideIndex = n;
                if (slideIndex > slides.length) { slideIndex = 1; }
                if (slideIndex < 1) { slideIndex = slides.length; }
                slides.forEach(s => s.style.display = "none");
                let dots = dotsContainer.getElementsByClassName("dot");
                for (let i = 0; i < dots.length; i++) {
                    dots[i].className = dots[i].className.replace(" active", "");
                }
                slides[slideIndex - 1].style.display = "block";
                dots[slideIndex - 1].className += " active";
                window[slideIndexVarName] = slideIndex;
            };
        }

        window.plusImageSlides = (n) => window.showImageSlides(imageSlideIndex += n);
        window.currentImageSlide = (n) => window.showImageSlides(imageSlideIndex = n);
        window.plusVideoSlides = (n) => window.showVideoSlides(videoSlideIndex += n);
        window.currentVideoSlide = (n) => window.showVideoSlides(videoSlideIndex = n);
        window.plusFeedbackSlides = (n) => window.showFeedbackSlides(feedbackSlideIndex += n);
        window.currentFeedbackSlide = (n) => window.showFeedbackSlides(feedbackSlideIndex = n);

        async function fetchProductDetails() {
            try {
                const q = query(collection(db, "products"), orderBy("createdAt", "desc"), limit(1));
                const querySnapshot = await getDocs(q);
                const renderImageSlider = setupSlider('imageSlider', 'slider-image', 'imageDots', 'Image');
                const renderVideoSlider = setupSlider('videoSlider', 'slider-video', 'videoDots', 'Video');
                if (!querySnapshot.empty) {
                    const productData = querySnapshot.docs[0].data();
                    document.getElementById('productTitle').innerText = productData.title || "Default Title";
                    renderImageSlider(productData.imageUrls);
                    renderVideoSlider(productData.videoUrls);
                } else {
                    renderImageSlider([]);
                    renderVideoSlider([]);
                }
            } catch (error) { console.error("Error fetching product details: ", error); }
        }
        
        let DELIVERY_FEE = 70;
        let prices = {
            medium_24: 200, medium_48: 300,
            big_24: 300, big_48: 400
        };

        function generateList(listString, titleElId, ulElId, subtitleElId) {
            const titleElement = document.getElementById(titleElId);
            const ulElement = document.getElementById(ulElId);
            const subtitleElement = document.getElementById(subtitleElId);
            
            ulElement.innerHTML = '';
            
            if (listString && typeof listString === 'string') {
                const lines = listString.split('\n').filter(line => line.trim() !== '');
                if (lines.length > 0) {
                    titleElement.innerText = lines.shift(); 
                    
                    if (subtitleElement && lines.length > 0) {
                        subtitleElement.classList.remove('hidden');
                    }

                    lines.forEach(itemText => {
                        const li = document.createElement('li');
                        li.innerText = itemText;
                        ulElement.appendChild(li);
                    });
                }
            }
        }
        
        async function fetchSiteSettings() {
            try {
                const contactSnap = await getDoc(doc(db, "settings", "contactInfo"));
                if (contactSnap.exists()) {
                    const data = contactSnap.data();
                    // Setup WhatsApp
                    const whatsappNumber = data.whatsappNumber;
                    if (whatsappNumber) {
                        document.getElementById('whatsapp-chat-link').href = `https://wa.me/${whatsappNumber}`;
                        document.getElementById('whatsapp-chat-link').style.display = 'flex';
                    }
                    // Setup Messenger
                    const messengerId = data.messengerPageId;
                    if (messengerId) {
                        document.getElementById('messenger-chat-link').href = `https://m.me/${messengerId}`;
                        document.getElementById('messenger-chat-link').style.display = 'flex';
                    }
                }
            } catch (error) { console.error("Error fetching contact settings:", error); }

            try {
                const contentSnap = await getDoc(doc(db, "settings", "siteContent"));
                if (contentSnap.exists()) {
                    const data = contentSnap.data();
                    if (data.mainDescription) document.getElementById('main-description').innerText = data.mainDescription;
                    
                    generateList(data.package24List, 'package-24-title', 'package-24-ul');
                    generateList(data.package48List, 'package-48-title', 'package-48-ul', 'package-48-subtitle');

                    prices.medium_24 = data.priceMedium24 || prices.medium_24;
                    prices.medium_48 = data.priceMedium48 || prices.medium_48;
                    prices.big_24 = data.priceBig24 || prices.big_24;
                    prices.big_48 = data.priceBig48 || prices.big_48;
                    DELIVERY_FEE = data.deliveryCharge || DELIVERY_FEE;
                    
                    updatePrice();
                }
            } catch (error) { console.error("Error fetching site content:", error); }
            
            try {
                const wheelSnap = await getDoc(doc(db, "settings", "spinningWheel"));
                if (wheelSnap.exists()) {
                    const wheelData = wheelSnap.data();
                    const tempRewards = [];
                    for (let i = 1; i <= 9; i++) {
                        tempRewards.push(wheelData[`reward${i}`] || `Prize ${i}`);
                    }
                    rewards = tempRewards;
                    setupWheel();
                }
            } catch (error) { console.error("Error fetching wheel settings:", error); }

            try {
                const feedbackSnap = await getDoc(doc(db, "settings", "customerFeedback"));
                if (feedbackSnap.exists()) {
                    const data = feedbackSnap.data();
                    const section = document.getElementById('customer-feedback-section');
                    const titleEl = document.getElementById('feedback-title');
                    const descEl = document.getElementById('feedback-description');
                    
                    if (data.title && data.description && data.imageUrls && data.imageUrls.length > 0) {
                        titleEl.innerText = data.title;
                        descEl.innerText = data.description;
                        
                        const renderFeedbackSlider = setupSlider('feedback-slider-container', 'slider-image', 'feedback-dots-container', 'Feedback');
                        renderFeedbackSlider(data.imageUrls);

                        section.classList.remove('hidden');
                    }
                }
            } catch (error) { console.error("Error fetching customer feedback:", error); }
        }

        const orderForm = document.getElementById('orderForm');
        orderForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitButton = orderForm.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerText = 'অর্ডার জমা হচ্ছে...';

            try {
                const docRef = await addDoc(collection(db, "orders"), {
                    name: orderForm.name.value,
                    address: orderForm.address.value,
                    phone: orderForm.phone.value,
                    note: orderForm.note.value,
                    product: orderForm.selectedProduct.value,
                    price: parseInt(orderForm.productPriceInput.value),
                    deliveryFee: DELIVERY_FEE,
                    totalPrice: parseInt(orderForm.totalPriceInput.value),
                    status: "Pending",
                    timestamp: new Date(),
                    reward: "Not Spun Yet",

                    // --- ADD THESE TWO LINES ---
                    fbp: getCookie('_fbp'), // Gets the Browser ID cookie
                    fbc: getCookie('_fbc')  // Gets the Click ID cookie (if it exists)
                });

                lastOrderId = docRef.id;

                // --- NEW: Generate and save Unique Order ID and user details ---
                const phone = orderForm.phone.value;
                const lastSixPhone = phone.slice(-6);
                const today = new Date();
                const day = String(today.getDate()).padStart(2, '0');
                const randDomDateTimeString=new Date().valueOf();
               // const generatedOrderId = `Nawarika${day}${lastSixPhone}`;
                const generatedOrderId = `Nawarika${randDomDateTimeString}`;

                let ipAddress = 'Unknown';
                let userAgent = navigator.userAgent;
                try {
                    const response = await fetch(`https://api.ipdata.co?api-key=cc45fc38076fbd77036417aae96d8231c5bb3c8fdbdbb4ccc7d5bf3e`);
                    if (response.ok) {
                        const ipData = await response.json();
                        ipAddress = ipData.ip || 'Unknown';
                    }
                } catch (ipError) {
                    console.error("Could not fetch IP address for order.", ipError);
                }

                const orderRef = doc(db, "orders", docRef.id);
                await updateDoc(orderRef, {
                    orderId: generatedOrderId,
                    ipAddress: ipAddress,
                    userAgent: userAgent
                });
                
                document.getElementById('orderIdDisplay').textContent = generatedOrderId;
                // --- END NEW CODE ---

                lastOrderedSize = document.querySelector('input[name="size"]:checked').value;
                lastOrderedQuantity = document.querySelector('input[name="quantity"]:checked').value;
                
                orderForm.style.display = 'none';
                document.querySelector('.my-6.text-center.bg-gray-100').style.display = 'none';
                document.getElementById('productOptions').style.display = 'none';
                document.getElementById('successMessage').classList.remove('hidden');

                 // --- ADD THIS CODE FOR FACEBOOK PURCHASE TRACKING ---
                fbq('track', 'Purchase', {
                    currency: "BDT", 
                    value: parseInt(orderForm.totalPriceInput.value)
                });
                // --- END OF FACEBOOK CODE ---

                document.getElementById('spin-btn').disabled = false;
                document.getElementById('spin-activation-msg').style.display = 'none';
                
            } catch (e) {
                console.error("Error adding document: ", e);
                alert("An error occurred. Please try again.");
                submitButton.disabled = false;
                submitButton.innerText = 'অর্ডার কনফার্ম করুন';
            }
        });
        
        // NEW: Copy Order ID functionality
        document.getElementById('copyOrderIdBtn').addEventListener('click', () => {
            const orderId = document.getElementById('orderIdDisplay').textContent;
            navigator.clipboard.writeText(orderId).then(() => {
                const btn = document.getElementById('copyOrderIdBtn');
                const originalText = btn.textContent;
                btn.textContent = 'কপি হয়েছে!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });
        });

        const productOptions = document.getElementById('productOptions');
        const dynamicPriceEl = document.getElementById('dynamicPrice');
        const deliveryFeeEl = document.getElementById('deliveryFee');
        const totalPriceEl = document.getElementById('totalPrice');
        const selectedProductEl = document.getElementById('selectedProduct');
        const productPriceInputEl = document.getElementById('productPriceInput');
        const totalPriceInputEl = document.getElementById('totalPriceInput');
        
        function updatePrice() {
            const selectedSize = document.querySelector('input[name="size"]:checked').value;
            const selectedQuantity = document.querySelector('input[name="quantity"]:checked').value;
            const key = `${selectedSize}_${selectedQuantity}`;
            
            const productPrice = prices[key];
            const total = productPrice + DELIVERY_FEE;

            dynamicPriceEl.textContent = productPrice;
            deliveryFeeEl.textContent = DELIVERY_FEE;
            totalPriceEl.textContent = total;
            
            const sizeText = selectedSize === 'medium' ? 'মিডিয়াম' : 'বড়';
            const quantityText = `${selectedQuantity} পিস`;
            selectedProductEl.value = `${sizeText} - ${quantityText}`;
            productPriceInputEl.value = productPrice;
            totalPriceInputEl.value = total;
            
            const package24Details = document.getElementById('package-24-details');
            const package48Details = document.getElementById('package-48-details');
            if (selectedQuantity === '24') {
                package24Details.classList.remove('hidden');
                package48Details.classList.add('hidden');
            } else {
                package48Details.classList.remove('hidden');
                package24Details.classList.add('hidden');
            }
        }

        const wheel = document.getElementById('wheel');
        const spinBtn = document.getElementById('spin-btn');
        const spinResultEl = document.getElementById('spin-result');
        const segmentCount = 9;
        
        function setupWheel() {
            wheel.innerHTML = '';
            const segmentAngle = 360 / segmentCount;
            const colors = ['#fecaca', '#fed7aa', '#fef08a', '#d9f99d', '#bfdbfe', '#e9d5ff', '#fed7e2', '#ccfbf1', '#d1d5db'];
            for (let i = 0; i < segmentCount; i++) {
                const segment = document.createElement('div');
                segment.className = 'segment';
                segment.style.transform = `rotate(${i * segmentAngle}deg)`;
                segment.style.backgroundColor = colors[i % colors.length];
                const rewardText = rewards[i] || `Prize ${i+1}`;
                segment.innerHTML = `<span>${rewardText}</span>`;
                wheel.appendChild(segment);
            }
        }

        spinBtn.addEventListener('click', () => {
            if (!lastOrderId) {
                alert("Please place an order first to spin the wheel.");
                return;
            }
            spinBtn.disabled = true;
            spinResultEl.textContent = '';

            let validSlots = [];
            if (lastOrderedSize === 'medium' && lastOrderedQuantity === '24') {
                validSlots = [0, 1]; // Slots 1-2
            } else if (lastOrderedSize === 'medium' && lastOrderedQuantity === '48') {
                validSlots = [0,1,2,3]; // Slots 1-4
            } else if (lastOrderedSize === 'big' && lastOrderedQuantity === '24') {
                validSlots = [0,1,2,3]; // Slots 1-4
            } else if (lastOrderedSize === 'big' && lastOrderedQuantity === '48') {
                validSlots = [0,1,2,3,4,5]; // Slots 1-6
            } else {
                validSlots = [0, 1, 2, 3, 4, 5];
            }

            const winningSegmentIndex = validSlots[Math.floor(Math.random() * validSlots.length)];
            
            const segmentAngle = 360 / segmentCount;
            const randomOffsetInSegment = Math.random() * (segmentAngle - 10) + 5;
            const targetAngle = 360 - (winningSegmentIndex * segmentAngle) - randomOffsetInSegment;
            
            const randomSpins = Math.floor(Math.random() * 5) + 5;
            const totalRotation = (randomSpins * 360) + targetAngle;
            
            wheel.style.transform = `rotate(${totalRotation}deg)`;

            setTimeout(async () => {
                const winningReward = rewards[winningSegmentIndex];
                spinResultEl.textContent = `অভিনন্দন! আপনি জিতেছেন: ${winningReward}`;

                if (lastOrderId && winningReward) {
                    try {
                        const orderRef = doc(db, "orders", lastOrderId);
                        await updateDoc(orderRef, { reward: winningReward });
                    } catch (error) {
                        console.error("Error updating order with reward:", error);
                    }
                }
            }, 5500);
        });

        // --- NEW: ORDER TRACKING AND EDITING LOGIC ---
        const trackOrderForm = document.getElementById('trackOrderForm');
        trackOrderForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const trackButton = trackOrderForm.querySelector('button[type="submit"]');
            trackButton.disabled = true;
            trackButton.textContent = 'অনুসন্ধান চলছে...';

            const trackingInput = document.getElementById('trackingInput').value.trim();
            const trackingResultDiv = document.getElementById('trackingResult');
            const trackingErrorP = document.getElementById('trackingError');

            trackingResultDiv.innerHTML = '';
            trackingResultDiv.classList.add('hidden');
            trackingErrorP.classList.add('hidden');

            const ordersRef = collection(db, "orders");
            const q1 = query(ordersRef, where("orderId", "==", trackingInput));
            const q2 = query(ordersRef, where("phone", "==", trackingInput), orderBy("timestamp", "desc"), limit(1));

            try {
                const [snapshot1, snapshot2] = await Promise.all([getDocs(q1), getDocs(q2)]);
                let orderDoc = null;

                if (!snapshot1.empty) {
                    orderDoc = snapshot1.docs[0];
                } else if (!snapshot2.empty) {
                    orderDoc = snapshot2.docs[0];
                }

                if (orderDoc) {
                    displayOrderDetails(orderDoc.id, orderDoc.data());
                } else {
                    trackingErrorP.textContent = 'দুঃখিত, এই তথ্য দিয়ে কোনো অর্ডার খুঁজে পাওয়া যায়নি।';
                    trackingErrorP.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Error searching for order:", error);
                trackingErrorP.textContent = 'অনুসন্ধান করতে একটি সমস্যা হয়েছে। আবার চেষ্টা করুন।';
                trackingErrorP.classList.remove('hidden');
            } finally {
                trackButton.disabled = false;
                trackButton.textContent = 'ট্র্যাক করুন';
            }
        });

        function displayOrderDetails(docId, data) {
            const container = document.getElementById('trackingResult');
            const statusColors = {
                'Pending': 'text-yellow-600',
                'Confirmed': 'text-indigo-600',
                'Preparing': 'text-purple-600',
                'Shipped': 'text-blue-600',
                'Delivered': 'text-green-600',
                'Canceled': 'text-red-600'
            };
            const statusColor = statusColors[data.status] || 'text-gray-700';

            let editButtonHtml = '';
            if (data.status === 'Pending' || data.status === 'Canceled') {
                editButtonHtml = `
                    <div class="text-right mt-4">
                        <button id="editOrderBtn" data-id="${docId}" class="bg-yellow-500 text-white font-bold py-2 px-4 rounded-md hover:bg-yellow-600 transition">তথ্য এডিট করুন</button>
                    </div>
                `;
            }

            container.innerHTML = `
                <div class="border p-4 rounded-md bg-gray-50">
                    <div id="orderDetailsFields" class="space-y-3 text-gray-800">
                        <p><strong>অর্ডার নাম্বার:</strong> <span class="font-mono">${data.orderId || 'N/A'}</span></p>
                        <p><strong>স্ট্যাটাস:</strong> <span class="font-bold ${statusColor}">${data.status}</span></p>
                        <p><strong>পুরস্কার:</strong> ${data.reward}</p>
                        <hr class="my-3">
                        <p><strong>নাম:</strong> ${data.name}</p>
                        <p><strong>ঠিকানা:</strong> ${data.address}</p>
                        <p><strong>ফোন:</strong> ${data.phone}</p>
                        <p><strong>বিশেষ দ্রষ্টব্য:</strong> ${data.note || 'N/A'}</p>
                    </div>
                    ${editButtonHtml}
                </div>
            `;
            container.classList.remove('hidden');

            const editButton = document.getElementById('editOrderBtn');
            if (editButton) {
                editButton.addEventListener('click', (e) => {
                    showEditForm(e.target.dataset.id, data);
                });
            }
        }


        function showEditForm(docId, data) {
            const container = document.getElementById('orderDetailsFields');
            container.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <label for="edit-name" class="block mb-1 font-medium text-gray-700">আপনার নাম <span class="text-red-500">*</span></label>
                        <input type="text" id="edit-name" class="w-full p-2 border border-gray-300 rounded-md" value="${data.name}" required>
                    </div>
                    <div>
                        <label for="edit-address" class="block mb-1 font-medium text-gray-700">আপনার সম্পূর্ণ ঠিকানা <span class="text-red-500">*</span></label>
                        <textarea id="edit-address" rows="3" class="w-full p-2 border border-gray-300 rounded-md">${data.address}</textarea>
                    </div>
                    <div>
                        <label for="edit-phone" class="block mb-1 font-medium text-gray-700">আপনার ফোন নম্বর <span class="text-red-500">*</span></label>
                        <input type="tel" id="edit-phone" class="w-full p-2 border border-gray-300 rounded-md" value="${data.phone}" required>
                    </div>
                     <div>
                        <label for="edit-note" class="block mb-1 font-medium text-gray-700">বিশেষ দ্রষ্টব্য</label>
                        <textarea id="edit-note" rows="2" class="w-full p-2 border border-gray-300 rounded-md">${data.note || ''}</textarea>
                    </div>
                </div>
            `;

            const actionsDiv = document.querySelector('#trackingResult .text-right');
            actionsDiv.innerHTML = `
                <button id="saveChangesBtn" data-id="${docId}" class="bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700 transition">সেভ করুন</button>
                <button id="cancelEditBtn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-md hover:bg-gray-600 transition ml-2">বাতিল</button>
            `;

            document.getElementById('cancelEditBtn').addEventListener('click', () => {
                 displayOrderDetails(docId, data);
            });

            document.getElementById('saveChangesBtn').addEventListener('click', async (e) => {
                const saveButton = e.target;
                saveButton.disabled = true;
                saveButton.textContent = 'সেভ হচ্ছে...';

                const updatedData = {
                    name: document.getElementById('edit-name').value,
                    address: document.getElementById('edit-address').value,
                    phone: document.getElementById('edit-phone').value,
                    note: document.getElementById('edit-note').value,
                };

                if (!updatedData.name || !updatedData.address || !updatedData.phone) {
                    alert("দয়া করে নাম, ঠিকানা এবং ফোন নাম্বার পূরণ করুন।");
                    saveButton.disabled = false;
                    saveButton.textContent = 'সেভ করুন';
                    return;
                }

                const orderRef = doc(db, "orders", e.target.dataset.id);
                try {
                    await updateDoc(orderRef, updatedData);
                    alert("আপনার তথ্য সফলভাবে আপডেট করা হয়েছে।");
                    const refreshedData = { ...data, ...updatedData };
                    displayOrderDetails(e.target.dataset.id, refreshedData);
                } catch (error) {
                    console.error("Error updating document: ", error);
                    alert("তথ্য আপডেট করতে একটি সমস্যা হয়েছে।");
                    saveButton.disabled = false;
                    saveButton.textContent = 'সেভ করুন';
                }
            });
        }
        // --- END OF NEW TRACKING LOGIC ---

        let visitorDocId = null;
        let visitStartTime = null;
        async function trackVisitor() {
            try {
                const apiKey = "cc45fc38076fbd77036417aae96d8231c5bb3c8fdbdbb4ccc7d5bf3e";
                const response = await fetch(`https://api.ipdata.co?api-key=${apiKey}`);
                
                if (!response.ok) return;
                const data = await response.json();
                
                const ip = data.ip || "Unknown";
                const userAgent = navigator.userAgent;

                const visitorsRef = collection(db, "visitors");
                const q = query(visitorsRef, where("ipAddress", "==", ip), where("userAgent", "==", userAgent));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const existingVisitorDoc = querySnapshot.docs[0];
                    visitorDocId = existingVisitorDoc.id;
                    visitStartTime = new Date();
                    
                    await updateDoc(doc(db, "visitors", visitorDocId), {
                        startTime: visitStartTime,
                        durationMillis: 0,
                        visitCount: increment(1)
                    });

                } else {
                    const visitorData = {
                        ipAddress: ip,
                        location: `${data.city || 'Unknown'}, ${data.country_name || 'Unknown'}`,
                        startTime: new Date(),
                        durationMillis: 0,
                        userAgent: userAgent,
                        visitCount: 1
                    };
                    visitStartTime = visitorData.startTime;
                    const docRef = await addDoc(collection(db, "visitors"), visitorData);
                    visitorDocId = docRef.id;
                }

            } catch (error) {
                 console.error("Error tracking visitor. This may be due to an ad blocker.", error);
            }
        }

        function updateVisitDuration() {
            if (visitorDocId && visitStartTime) {
                const duration = new Date() - visitStartTime;
                updateDoc(doc(db, "visitors", visitorDocId), { durationMillis: duration });
            }
        }

        function checkUrlForOrderId() {
    const params = new URLSearchParams(window.location.search);
    const orderId = params.get('orderId');
    if (orderId) {
        const trackingInput = document.getElementById('trackingInput');
        const trackButton = document.querySelector('#trackOrderForm button[type="submit"]');
        const trackingSection = document.getElementById('order-tracking-section');
        
        if (trackingInput && trackButton && trackingSection) {
            trackingInput.value = orderId;
            // Click the button first to start fetching the order details.
            trackButton.click();
            
            // Delay the scroll for 2 seconds (2000ms) to allow the results
            // to load and render before the page scrolls to them.
            setTimeout(() => {
                trackingSection.scrollIntoView({ behavior: 'smooth' });
            }, 2000);
        }
    }
}

        productOptions.addEventListener('change', updatePrice);
        
        document.addEventListener('DOMContentLoaded', () => {
             fetchProductDetails();
             fetchSiteSettings();
             trackVisitor();
             updatePrice();
        });

        // --- MODIFIED: Run URL check only after the window, including all images, is fully loaded. ---
        window.addEventListener('load', () => {
            checkUrlForOrderId();
        });

        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') updateVisitDuration();
        });
        window.addEventListener('beforeunload', updateVisitDuration);

        document.getElementById('scrollToSpinBtn').addEventListener('click', () => {
            const spinContainer = document.getElementById('spin-container');
            if (spinContainer) {
                spinContainer.scrollIntoView({ behavior: 'smooth' });
                setTimeout(() => {
                    const spinButton = document.getElementById('spin-btn');
                    if (spinButton && !spinButton.disabled) {
                        spinButton.click();
                    }
                }, 1000); 
            }
        });

    </script>
    
</body>
</html>